<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password dimenticata - BurgTV</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0a0b;--bg2:#111113;--text:#fff;--muted:#a0a0a8;--accent:#B94A8E;--accent-light:#d85aa3;--accent-dark:#7B4397;--success:#10b981;--error:#ef4444;--border:rgba(255,255,255,0.12);--card:rgba(255,255,255,0.03)}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,var(--bg),var(--bg2));color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem 1rem}
        body::before{content:'';position:fixed;inset:0;background:radial-gradient(circle at 20% 50%,rgba(185,74,142,0.08),transparent 50%),radial-gradient(circle at 80% 80%,rgba(123,67,151,0.08),transparent 50%);pointer-events:none}
        .back-btn{position:fixed;top:1.5rem;left:1.5rem;display:none;align-items:center;gap:8px;padding:0.75rem 1.25rem;background:var(--card);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:12px;color:var(--text);text-decoration:none;font-size:0.9rem;z-index:1000}
        .back-btn:hover{background:rgba(255,255,255,0.06)}
        @media(min-width:769px){.back-btn{display:flex}}
        .container{width:100%;max-width:440px;background:var(--card);border:1px solid var(--border);border-radius:24px;padding:40px 32px;backdrop-filter:blur(20px);position:relative;z-index:1}
        .logo-section{text-align:center;margin-bottom:32px}
        .logo-img{height:64px;width:auto;margin-bottom:16px}
        .logo-section h1{font-size:24px;font-weight:700;margin-bottom:8px}
        .logo-section p{color:var(--muted);font-size:14px;line-height:1.6}
        .step{display:none}.step.active{display:block}
        .form-group{position:relative;margin-bottom:20px}
        .form-input{width:100%;padding:18px 16px;font-size:16px;background:transparent;border:2px solid var(--border);border-radius:12px;color:var(--text);outline:none}
        .form-input:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(185,74,142,0.15)}
        .form-input:focus+.form-label,.form-input:not(:placeholder-shown)+.form-label{top:-10px;left:12px;font-size:12px;background:var(--bg2);padding:0 8px;color:var(--accent)}
        .form-label{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:16px;pointer-events:none;transition:all 0.3s}
        .otp-input{text-align:center;font-size:28px;letter-spacing:8px;font-weight:700}
        .btn{width:100%;padding:16px;font-size:16px;font-weight:600;background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff;border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
        .btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(185,74,142,0.4)}
        .btn:disabled{opacity:0.7;cursor:not-allowed;transform:none}
        .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .message{padding:14px 16px;border-radius:12px;font-size:14px;margin-bottom:20px;display:none;align-items:center;gap:10px}
        .message.error{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#fca5a5}
        .message.success{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#6ee7b7}
        .message.show{display:flex}
        .back-login{text-align:center;margin-top:24px}
        .back-login a{color:var(--accent);text-decoration:none;font-size:14px}
        .back-login a:hover{color:var(--accent-light)}
        .steps-indicator{display:flex;justify-content:center;gap:8px;margin-bottom:24px}
        .step-dot{width:10px;height:10px;border-radius:50%;background:var(--border)}
        .step-dot.active{background:var(--accent)}
        .step-dot.done{background:var(--success)}
        .resend-link{text-align:center;margin-top:16px;font-size:13px;color:var(--muted)}
        .resend-link a{color:var(--accent);cursor:pointer;text-decoration:underline}
        @media(min-width:769px){.container{max-width:520px;padding:48px 40px}.logo-img{height:80px}.logo-section h1{font-size:28px}.form-input{padding:20px 18px;font-size:17px}.btn{padding:18px;font-size:17px}}
    </style>
</head>
<body>
    <a href="login.html" class="back-btn">
        <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Indietro
    </a>
    <div class="container">
        <div class="logo-section">
            <img src="logo.png" alt="BurgTV" class="logo-img">
            <h1 id="stepTitle">Password dimenticata</h1>
            <p id="stepDesc">Inserisci la tua email per ricevere un codice di verifica.</p>
        </div>

        <div class="steps-indicator">
            <div class="step-dot active" id="dot1"></div>
            <div class="step-dot" id="dot2"></div>
            <div class="step-dot" id="dot3"></div>
        </div>

        <div class="message error" id="errorMessage"><span id="errorText"></span></div>
        <div class="message success" id="successMessage"><span id="successText"></span></div>

        <!-- Step 1: Email -->
        <div class="step active" id="step1">
            <form onsubmit="sendOTP(event)">
                <div class="form-group">
                    <input type="email" id="email" class="form-input" placeholder=" " required autocomplete="email">
                    <label for="email" class="form-label">Email</label>
                </div>
                <button type="submit" class="btn" id="btn1">Invia codice</button>
            </form>
        </div>

        <!-- Step 2: OTP -->
        <div class="step" id="step2">
            <form onsubmit="verifyOTP(event)">
                <div class="form-group">
                    <input type="text" id="otp" class="form-input otp-input" placeholder=" " required maxlength="6" pattern="[0-9]{6}">
                    <label for="otp" class="form-label">Codice a 6 cifre</label>
                </div>
                <button type="submit" class="btn" id="btn2">Verifica</button>
            </form>
            <div class="resend-link">Non hai ricevuto il codice? <a onclick="resendOTP()">Invia di nuovo</a></div>
        </div>

        <!-- Step 3: New Password -->
        <div class="step" id="step3">
            <form onsubmit="resetPassword(event)">
                <div class="form-group">
                    <input type="password" id="newPassword" class="form-input" placeholder=" " required minlength="6">
                    <label for="newPassword" class="form-label">Nuova password</label>
                </div>
                <div class="form-group">
                    <input type="password" id="confirmPassword" class="form-input" placeholder=" " required>
                    <label for="confirmPassword" class="form-label">Conferma password</label>
                </div>
                <button type="submit" class="btn" id="btn3">Salva password</button>
            </form>
        </div>

        <div class="back-login"><a href="login.html">Torna al login</a></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ugspmqfduabfmfsoxqoc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnc3BtcWZkdWFiZm1mc294cW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1NTMyMDEsImV4cCI6MjA2MDEyOTIwMX0.1Xj4sa51Wi8U1Ebm4B3DE5JxCR3eTx2TQUxfV0TaA-I';

        let currentStep = 1;
        let userEmail = '';
        let resetToken = '';

        function showStep(step) {
            currentStep = step;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');

            document.querySelectorAll('.step-dot').forEach((d, i) => {
                d.classList.remove('active', 'done');
                if (i + 1 < step) d.classList.add('done');
                if (i + 1 === step) d.classList.add('active');
            });

            const titles = ['Password dimenticata', 'Inserisci il codice', 'Nuova password'];
            const descs = [
                'Inserisci la tua email per ricevere un codice di verifica.',
                'Abbiamo inviato un codice a 6 cifre alla tua email.',
                'Scegli una nuova password sicura.'
            ];
            document.getElementById('stepTitle').textContent = titles[step - 1];
            document.getElementById('stepDesc').textContent = descs[step - 1];
            hideMessages();
        }

        function showError(msg) {
            document.getElementById('errorText').textContent = msg;
            document.getElementById('errorMessage').classList.add('show');
            document.getElementById('successMessage').classList.remove('show');
        }

        function showSuccess(msg) {
            document.getElementById('successText').textContent = msg;
            document.getElementById('successMessage').classList.add('show');
            document.getElementById('errorMessage').classList.remove('show');
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('successMessage').classList.remove('show');
        }

        function setLoading(btnId, loading) {
            const btn = document.getElementById(btnId);
            btn.disabled = loading;
            const originalText = btn.dataset.text || btn.textContent;
            if (!btn.dataset.text) btn.dataset.text = originalText;
            btn.innerHTML = loading ? '<span class="spinner"></span>' : originalText;
        }

        async function sendOTP(e) {
            e.preventDefault();
            hideMessages();
            userEmail = document.getElementById('email').value.trim();

            setLoading('btn1', true);

            try {
                const res = await fetch(`${SUPABASE_URL}/functions/v1/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({ email: userEmail })
                });

                const data = await res.json();

                if (data.success) {
                    showStep(2);
                } else {
                    showError(data.error || 'Errore nell\'invio del codice');
                }
            } catch (err) {
                showError('Errore di connessione');
            }

            setLoading('btn1', false);
        }

        async function resendOTP() {
            setLoading('btn2', true);
            try {
                await fetch(`${SUPABASE_URL}/functions/v1/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({ email: userEmail })
                });
                showSuccess('Codice inviato nuovamente!');
            } catch (err) {
                showError('Errore nell\'invio');
            }
            setLoading('btn2', false);
        }

        async function verifyOTP(e) {
            e.preventDefault();
            hideMessages();
            const otp = document.getElementById('otp').value.trim();

            if (otp.length !== 6) {
                showError('Il codice deve essere di 6 cifre');
                return;
            }

            setLoading('btn2', true);

            try {
                const res = await fetch(`${SUPABASE_URL}/functions/v1/verify-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({ email: userEmail, otp })
                });

                const data = await res.json();

                if (data.success && data.reset_token) {
                    resetToken = data.reset_token;
                    showStep(3);
                } else {
                    showError(data.error || 'Codice non valido o scaduto');
                }
            } catch (err) {
                showError('Errore di connessione');
            }

            setLoading('btn2', false);
        }

        async function resetPassword(e) {
            e.preventDefault();
            hideMessages();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword.length < 6) {
                showError('La password deve avere almeno 6 caratteri');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Le password non corrispondono');
                return;
            }

            setLoading('btn3', true);

            try {
                const res = await fetch(`${SUPABASE_URL}/functions/v1/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        email: userEmail,
                        reset_token: resetToken,
                        new_password: newPassword
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showSuccess('Password aggiornata! Reindirizzamento...');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showError(data.error || 'Errore nel salvataggio');
                }
            } catch (err) {
                showError('Errore di connessione');
            }

            setLoading('btn3', false);
        }
    </script>
</body>
</html>
